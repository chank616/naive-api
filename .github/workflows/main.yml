name: Deploy on Tag Release

on:
  push:
    tags:
      - 'v*'  # åªç›‘å¬ä»¥ v å¼€å¤´çš„æ ‡ç­¾ (å¦‚ v1.0, v2.1.0)

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          # ä½¿ç”¨å¸¦æœ‰ç‰ˆæœ¬å·çš„é•œåƒæ ‡ç­¾éƒ¨ç½²
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² naive-api:${GITHUB_REF#refs/tags/} ç‰ˆæœ¬..."
            
            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„ Docker é•œåƒ
            sudo docker pull chank616/naive-api:${GITHUB_REF#refs/tags/}
            
            # åœæ­¢å¹¶ç§»é™¤ç°æœ‰å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            sudo docker stop naive-api || true
            sudo docker rm naive-api || true
            
            # è¿è¡Œæ–°ç‰ˆæœ¬å®¹å™¨
            sudo docker run -d \
              --name naive-api \
              -p 8000:8000 \
              -e TZ=Asia/Shanghai \
              -v /app/config:/app/config \
              --restart=unless-stopped \
              chank616/naive-api:${GITHUB_REF#refs/tags/}
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼å½“å‰è¿è¡Œç‰ˆæœ¬: ${GITHUB_REF#refs/tags/}"
            sudo docker ps --filter "name=naive-api"
